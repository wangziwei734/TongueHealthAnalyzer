# 智能中医舌诊系统 👅

## 📋 项目介绍

本系统是一个基于计算机视觉和机器学习的中医舌诊分析系统，通过对舌像图片进行处理、分割和特征提取，自动评估用户的整体健康状况以及心、肝、脾、肺、肾五脏的健康情况，并给出相应的中医诊断建议。

### ✨ 系统特色

- **传统医学与现代技术的结合**：将传统中医舌诊理论与现代人工智能技术相结合
- **自动化舌体识别与分割**：使用深度学习模型自动检测并分割舌体区域
- **多区域健康评估**：将舌体划分为对应五脏的区域，分别进行分析
- **个性化健康记录**：记录用户历史健康数据，实现个性化分析
- **可解释性诊断结果**：不仅提供健康评分，还给出具体中医诊断建议
- **优化的模型加载机制**：单例模式模型加载和智能权重文件检测，提高系统响应速度

## 🛠️ 环境准备

### 依赖安装

在运行系统前，请确保已安装以下依赖：

```bash
pip install -r requirements.txt
```

## 📁 系统文件结构

```
ChineseMedicine/
├── run.py                   # 主程序入口
├── ChineseMedicine_analysis.py   # 中医分析主模块
├── analysis/                # 分析模块目录
│   ├── main.py              # 健康值计算主函数
│   ├── merge_features.py    # 特征融合函数
│   └── LS.csv               # 经验权重数据
├── tongue/                  # 舌诊模块目录
│   ├── haveTongue.py        # 舌体检测模块
│   ├── segmentation_tongue.py   # 舌面分割模块
│   └── tongue_segmentation/ # 舌体区域分割模块
├── keras_segmentation/      # 图像分割模块
├── weights/                 # 模型权重目录
│   └── resunet.*.h5         # 模型权重文件（h5格式）
├── example/                 # 示例图片和结果目录
│   ├── *.jpg                # 测试用的舌像图片
│   └── expert_diagnosis.xlsx   # 诊断结果记录表
├── upload/                  # 上传图片临时存储目录（自动创建）
├── features/                # 特征存储目录（自动创建）
│   └── [用户ID]/            # 按用户ID分类的特征目录
│       └── value.txt        # 用户历史健康值记录
├── compare/                 # 比较结果图片保存目录
├── prediction/              # 分割预测结果保存目录
├── tongue_data/             # 数据集目录
│   ├── train_img/           # 训练集图像
│   ├── train_label/         # 训练集标签
│   ├── test_img/            # 测试集图像
│   └── test_label/          # 测试集标签
├── requirements.txt         # 项目依赖清单
└── .gitignore               # Git忽略规则
```

## 🔄 模型加载机制说明

系统采用了优化的模型加载机制，提高运行效率：

1. **单例模式**：使用全局变量确保模型只加载一次，避免重复加载
2. **高效权重查找**：采用直接文件名解析方式，快速定位最高轮次的权重文件
3. **模块间共享**：不同模块间共享同一个模型实例，减少内存占用
4. **懒加载机制**：只在实际需要使用时才加载模型，优化资源利用
5. **h5格式支持**：支持TensorFlow的h5格式权重文件，确保版本兼容性

此机制显著减少了系统启动和分析过程中的延迟。

## 🧪 模型测试与评估

### 🔬 使用test.py进行模型测试

您可以使用`test.py`脚本对训练好的模型进行性能测试：

```bash
python test.py
```

执行此命令会：

1. **加载最新的模型权重**: 自动查找并加载`weights`目录中轮次最高的h5格式权重文件
2. **预测测试集图像**: 对`tongue_data/test_img/`目录中的所有图像进行分割预测
3. **保存预测结果**: 将预测结果保存到`prediction/`目录
4. **评估模型性能**: 如果存在`tongue_data/test_label/`目录，会计算并输出模型的IoU指标

### 📊 准备测试数据

在使用测试功能前，请确保准备好测试数据：

1. 创建测试图像目录: `tongue_data/test_img/`
2. 创建测试标签目录: `tongue_data/test_label/` (用于评估，可选)
3. 将测试图像和对应标签放入相应目录

您也可以使用数据集划分工具自动生成这些目录:
```bash
python label/divide_datasets.py
```

## 🔄 使用流程

### 👅 1. 运行舌体检测与分析

使用 `run.py` 文件进行舌体检测、分割和健康分析：

```bash
python run.py [图像路径]
```

如果不提供图像路径参数，系统将默认使用 `example/2.jpg` 作为输入图像。

#### 执行过程详解：

1. **输入图像** 📸
   - 系统默认使用 `example/2.jpg` 作为输入图像
   - 也可通过命令行参数指定其他图像

2. **舌体检测与分割** 🔍
   - 系统会自动检测图像中的舌体
   - 生成舌体区域的掩膜图像
   - 将舌体划分为对应五脏的不同区域

3. **健康分析** 📊
   - 计算整体健康值和五脏（心、肝、脾、肺、肾）健康值
   - 数值范围为[-1, 1]，越接近0表示越健康

4. **诊断结果** 📝
   - 根据各脏腑健康值，系统会给出相应的中医诊断建议
   - 如"血虚"、"脾虚"、"肾虚"、"气虚"、"肝郁"等
   - 如果各项指标都正常，则诊断为"健康"

5. **结果保存** 💾
   - 分析结果会自动保存到 `example/expert_diagnosis.xlsx` 文件中
   - 每次分析都会新增一条记录，不会覆盖历史数据

### 📂 2. 生成的文件及目录说明

#### 自动创建的目录：

1. **upload/** 文件夹
   - 用于临时存储处理中的图像
   - 分析完成后会自动清理

2. **features/[用户ID]/** 文件夹
   - 存储用户健康值历史记录
   - 每个用户一个独立目录，以用户ID命名
   - 目录下的 `value.txt` 文件记录用户历次检测的健康值

3. **prediction/** 和 **compare/** 文件夹
   - 存储分割结果和对比图像

#### 生成的文件：

1. **expert_diagnosis.xlsx**
   - 位置：`example/expert_diagnosis.xlsx`
   - 内容：所有用户的诊断记录
   - 字段包括：用户ID、检测时间、整体健康值、心、脾、肾、肺、肝、诊断结果

2. **value.txt**
   - 位置：`features/[用户ID]/value.txt`
   - 内容：特定用户的历史健康值记录
   - 格式：每行为一次检测结果，以逗号分隔的六个值（整体、心、脾、肾、肺、肝）

## 🧠 训练模型

本系统使用的舌体分割模型基于ResUNet架构，可以根据以下步骤训练自己的模型：

### 1. 数据集准备

首先使用数据集划分工具准备训练数据：

```bash
python label/divide_datasets.py
```

这会将数据集划分为训练集和测试集。确保您的数据集目录结构如下：

```
tongue_data/
├── train_img/      # 训练集图像
├── train_label/    # 训练集标签
├── test_img/       # 测试集图像
└── test_label/     # 测试集标签
```

### 2. 模型训练

使用以下命令开始训练：

```bash
python main_train.py
```

或者使用更详细的参数配置：

```bash
python -m keras_segmentation.train \
    --checkpoints_path="weights/resunet" \
    --train_images="tongue_data/train_img/" \
    --train_annotations="tongue_data/train_label/" \
    --val_images="tongue_data/test_img/" \
    --val_annotations="tongue_data/test_label/" \
    --n_classes=2 \
    --input_height=512 \
    --input_width=512 \
    --model_name="resunet" \
    --batch_size=8 \
    --epochs=50
```

参数说明：
- `--checkpoints_path`: 模型权重保存路径
- `--train_images`: 训练集图像路径
- `--train_annotations`: 训练集标注路径
- `--val_images`: 验证集图像路径
- `--val_annotations`: 验证集标注路径
- `--n_classes`: 分类数量（2表示二分类：舌体和背景）
- `--input_height/width`: 输入图像尺寸
- `--model_name`: 模型架构名称
- `--batch_size`: 批次大小
- `--epochs`: 训练轮数

### 3. 生成对比图像

训练后，可以使用 `comparison.py` 生成测试图像与预测结果的对比图：

```bash
python comparison.py
```

这会生成测试图像与对应预测结果的并排对比图，保存到 `compare/` 目录。

## 🚀 高级功能

### 1. 舌体区域划分

系统将舌体划分为对应五脏的区域：

- 舌尖部分对应肾
- 舌根部分对应肺
- 舌中部对应脾
- 舌两侧对应肝

### 2. 健康评分计算

系统基于提取的特征计算健康评分，使用经验权重和特征融合技术，结合用户历史数据进行个性化评估。

### 3. 特征提取与分析

从分割得到的舌体区域提取多种特征：

- **颜色特征**：分析舌体颜色，提取色相、饱和度、明度特征
- **纹理特征**：使用灰度共生矩阵(GLCM)等方法提取纹理特征
- **形态特征**：分析舌体形状、边缘特征
- **苔质特征**：分析舌苔厚度、分布情况

## ⚠️ 注意事项

1. 舌像图片需要光线适中，清晰可见，且舌体占据图像主要部分
2. 首次使用时会自动下载和配置模型权重
3. 诊断结果仅供参考，不能替代专业医生的诊断
4. 使用前请备份重要数据，尤其是运行数据集划分工具时
5. 模型训练需要较高的计算资源，建议使用GPU加速训练过程

## 🔮 未来工作

1. **多模态融合**：结合舌诊、脉诊等多种中医诊断方法
2. **移动端部署**：开发移动应用，方便用户自主检测
3. **多语言支持**：支持中英等多种语言界面
4. **个性化推荐**：基于诊断结果推荐个性化的保健建议
5. **数据挖掘**：对大量用户数据进行挖掘，发现疾病模式